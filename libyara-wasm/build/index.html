<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Yara WASM Test</title>
    <script src="build/libyara-wasm.js"></script>
    <script>
        Module.onRuntimeInitialized = _ => {
            document.forms["yara"].style.display = "block";
        };
        function runYara () {
            let cNode = document.getElementById("results").cloneNode(false);
            document.getElementById("results").parentNode.replaceChild(cNode, document.getElementById("results"));
            const rules = document.forms["yara"]["rules"].value;
            const data = document.forms["yara"]["data"].value;
            const resp = Module.run(data, rules);
            if (resp.compileErrors.size() > 0) {
                //console.log("Issues!");
                for (let i = 0; i < resp.compileErrors.size(); i++) {
                    const compileError = resp.compileErrors.get(i);
                    print(`Error on line ${compileError.lineNumber}: ${compileError.message}`);
                }
                return;
            }
            const matchedRules = resp.matchedRules;
            for (let i = 0; i < matchedRules.keys().size(); i++) {
                const rule_matches = matchedRules.get(matchedRules.keys().get(i));
                print(`Rule "${matchedRules.keys().get(i)}" matches:`);
                for (let j = 0; j < rule_matches.size(); j++) {
                    const match = rule_matches.get(j);
                    print(`Position ${match.location}, length ${match["match_length"]}, data: ${match.data}`);
                }

            }
        }
        function print (string) {
            const para = document.createElement("p");
            para.append(document.createTextNode(string));
            document.getElementById("results").appendChild(para);
        }
    </script>
</head>
<body>
<form name="yara" style="display: none">
    Rules:<br>
    <textarea cols="40" rows="5" name="rules">
rule foo {
    strings:
        $re1 = /foo/
    condition:
        $re1
}
rule bar {
    strings:
        $re1 = /bar/
    condition:
        $re1
}
    </textarea>
    <br>Data:<br>
    <textarea cols="40" rows="5" name="data">foobar foobar bar foo foobar</textarea>
    <br>
    <input type="button" value="Submit" onclick="runYara()">
</form>
<div id="results"></div>
</body>
</html>